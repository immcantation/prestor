---
header-includes: 
    \usepackage{titling}
    \pretitle{
      \begin{center}
      \includegraphics[width=\textwidth]{`r system.file("reports/presto.jpg", package="prestor")`}
      \end{center}
    }
    \posttitle{}
output:
    pdf_document:
        toc: true
    html_document:
        toc: true
params:
    title: "pRESTO Report: AbSeq v3"
    sample: "Sample"
    run: "Run"
    author: "Author"
    version: "Version"
    description: "Description"
    date: "Date"
    data: "../../test/logs"
    console: "pipeline.log"
    quality_r1: "quality-1_table.tab"
    quality_r2: "quality-2_table.tab"
    primers_r1: "primers-1_table.tab"
    primers_r2: "primers-2_table.tab"
    consensus_r1: "consensus-1_table.tab"
    consensus_r2: "consensus-2_table.tab"
    assemble: "assemble_table.tab"
    cregion: "cregion_table.tab"
    headers_total: "final-total_headers.tab"
    headers_unique: "final-unique_headers.tab"
    headers_atleast2: "final-unique-atleast2_headers.tab"
title: "`r params$title`"
---

```{r message=FALSE, echo=FALSE, results="hide", eval=TRUE}
# Setup
library(prestor)
library(knitr)
library(captioner)

# Options
knitr::opts_chunk$set(child.path=system.file("reports", package="prestor"))

# Define table and figure legend object
tables <- captioner(prefix="Table")
figures <- captioner(prefix="Figure")
```

```{r message=FALSE, echo=FALSE, results="hide"}
# Get set of report files
children <- c(front="Front.Rmd", 
              console="Paired-Console.Rmd",
              quality="Paired-Quality.Rmd", 
              primers="Paired-Primers.Rmd",
              consensus="Paired-Consensus.Rmd",
              assemble="Assembly.Rmd",
              cregion="CRegion.Rmd",
              headers="Headers.Rmd")

# Check files
file_eval <- c("front"=TRUE)
file_eval["console"] <- file.exists(file.path(params$data, params$console))
file_eval["quality"] <- all(file.exists(file.path(params$data, params$quality_r1)),
                            file.exists(file.path(params$data, params$quality_r2)))
file_eval["primers"] <- all(file.exists(file.path(params$data, params$primers_r1)),
                            file.exists(file.path(params$data, params$primers_r2)))
file_eval["consensus"] <- all(file.exists(file.path(params$data, params$consensus_r1)),
                              file.exists(file.path(params$data, params$consensus_r2)))
file_eval["assemble"] <- file.exists(file.path(params$data, params$assemble))
file_eval["cregion"] <- file.exists(file.path(params$data, params$cregion))
file_eval["headers"] <- all(file.exists(file.path(params$data, params$headers_total)),
                            file.exists(file.path(params$data, params$headers_unique)),
                            file.exists(file.path(params$data, params$headers_atleast2)))

# Remove missing files
child_eval <- children[file_eval]

eval_func <- function(options) { 
    options$eval <- (options$child %in% child_eval)
    options 
}

opts_hooks$set(eval=eval_func)
```

```{r child="Front.Rmd"}
```

```{r child="Paired-Console.Rmd"}
```

```{r child="Paired-Quality.Rmd"}
```

```{r child="Paired-Primers.Rmd"}
```

```{r child="Paired-Consensus.Rmd"}
```

```{r child="Assembly.Rmd"}
```

```{r child="CRegion.Rmd"}
```

```{r child="Headers.Rmd"}
```